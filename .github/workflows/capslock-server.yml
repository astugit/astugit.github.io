steps:
  - uses: actions/checkout@v3
    with:
      repository: nolenroyalty/global-capslock
      path: capslock

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: '3.12'

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install fastapi uvicorn websockets

  - name: Get public IP
    id: public_ip
    run: |
      set -euo pipefail
      IP=$(curl -fsS https://ipinfo.io/ip || curl -fsS https://ifconfig.co || dig +short myip.opendns.com @resolver1.opendns.com || echo "unknown")
      echo "Public IP: $IP"
      echo "public_ip=$IP" >> $GITHUB_OUTPUT

  - name: Run capslock server
    working-directory: capslock
    run: |
      echo "Starting capslock server..."
      echo "Runner public IP: ${{ steps.public_ip.outputs.public_ip }}"
      echo "Server will run for ${{ github.event.inputs.duration }} minutes"
      timeout ${{ github.event.inputs.duration }}m python example-server.py || true
    env:
      PORT: 8000
      PUBLIC_IP: ${{ steps.public_ip.outputs.public_ip }}