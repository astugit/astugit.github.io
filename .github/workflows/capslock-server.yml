name: Capslock Server

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to run the server (in minutes, max 360)'
        required: false
        default: '60'

permissions:
  contents: read

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3
        with:
          repository: nolenroyalty/global-capslock
          path: capslock

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn websockets
          sudo apt-get update -y
          sudo apt-get install -y unzip curl jq

      - name: Get IP Addresses
        id: ip
        uses: candidob/get-runner-ip@v1.0.0

      - name: See IP Addresses
        run: |
          echo ${{ steps.ip.outputs.ipv4 }}
          echo ${{ steps.ip.outputs.ipv6 }}

      - name: Run capslock server and ngrok tunnel
        working-directory: capslock
        env:
          PORT: 8080
          # Use repository secret named `ngrok` for the authtoken
          NGROK_AUTHTOKEN: ${{ secrets.ngrok }}
        run: |
          set -eo pipefail
          echo "Starting capslock server on port $PORT..."
          # Start the Python server in background and limit its runtime to the requested duration
          timeout ${{ github.event.inputs.duration }}m python example-server.py &
          SERVER_PID=$!

          echo "Downloading ngrok..."
          curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc \
          | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null \
          && echo "deb https://ngrok-agent.s3.amazonaws.com bookworm main" \
          | sudo tee /etc/apt/sources.list.d/ngrok.list \
          && sudo apt update \
          && sudo apt install ngrok

          echo "Configuring ngrok authtoken (token provided via workflow secrets)..."
          ngrok authtoken "$NGROK_AUTHTOKEN"

          echo "Starting ngrok with the exact command requested: ngrok http 80 (using host-header to forward to local port $PORT)"
          # Start ngrok in the background. The command is exactly "ngrok http 80" per your request,
          # while using host-header to allow the tunnel to reach the local app on port 8080.
          ./ngrok http 80
          NGROK_PID=$!

          echo "Server PID: $SERVER_PID"
          echo "ngrok PID: $NGROK_PID"

          # Wait for the server (the timeout will stop it after the requested duration)
          wait $SERVER_PID || true

          echo "Shutting down ngrok..."
          kill $NGROK_PID || true
          sleep 1
