name: Capslock Server

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'How long to run the server (in minutes, max 360)'
        required: false
        default: '60'

permissions:
  contents: read

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v3
        with:
          repository: nolenroyalty/global-capslock
          path: capslock

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install fastapi uvicorn websockets
          sudo apt-get update -y
          sudo apt-get install -y unzip curl jq

      - name: Get IP Addresses
        id: ip
        uses: candidob/get-runner-ip@v1.0.0

      - name: See IP Addresses
        run: |
          echo ${{ steps.ip.outputs.ipv4 }}
          echo ${{ steps.ip.outputs.ipv6 }}

      - name: Run capslock server and ngrok tunnel
        working-directory: capslock
        env:
          PORT: 8080
          # Use repository secret named `ngrok` for the authtoken
          NGROK_AUTHTOKEN: ${{ secrets.ngrok }}
        run: |
          set -eo pipefail
          echo "Starting capslock server on port $PORT..."
          # Start the Python server in background and limit its runtime to the requested duration
          timeout ${{ github.event.inputs.duration }}m python example-server.py &
          SERVER_PID=$!

          echo "Downloading ngrok..."
          curl -sL https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip -qq ngrok.zip
          chmod +x ngrok

          echo "Configuring ngrok authtoken (token provided via workflow secrets)..."
          ./ngrok authtoken "$NGROK_AUTHTOKEN"

          echo "Starting ngrok with the exact command requested: ngrok http 80 (using host-header to forward to local port $PORT)"
          # Start ngrok in the background. The command is exactly "ngrok http 80" per your request,
          # while using host-header to allow the tunnel to reach the local app on port 8080.
          nohup ./ngrok http 80 --host-header="localhost:$PORT" --log=stdout --log-format=json > ngrok.log 2>&1 &
          NGROK_PID=$!

          echo "Waiting for ngrok local API to become available..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:4040/api/tunnels >/dev/null 2>&1; then
              break
            fi
            sleep 1
          done

          echo "Retrieving ngrok public URL(s)..."
          # Query ngrok's local API to get public URL(s)
          TUNNELS_JSON=$(curl -s http://127.0.0.1:4040/api/tunnels || true)
          echo "ngrok API response: $TUNNELS_JSON"

          # Try to extract the http public_url (falls back gracefully)
          PUBLIC_HTTP_URL=$(echo "$TUNNELS_JSON" | jq -r '.tunnels[] | select(.proto=="http") | .public_url' | head -n1 || true)
          PUBLIC_HTTPS_URL=$(echo "$TUNNELS_JSON" | jq -r '.tunnels[] | select(.proto=="https") | .public_url' | head -n1 || true)

          if [ -n "$PUBLIC_HTTP_URL" ]; then
            echo "ngrok HTTP public URL: $PUBLIC_HTTP_URL"
            DOMAIN=$(echo "$PUBLIC_HTTP_URL" | sed -E 's#https?://##')
            echo "Domain connecting to port $PORT via ngrok: $DOMAIN"
          elif [ -n "$PUBLIC_HTTPS_URL" ]; then
            echo "ngrok HTTPS public URL: $PUBLIC_HTTPS_URL"
            DOMAIN=$(echo "$PUBLIC_HTTPS_URL" | sed -E 's#https?://##')
            echo "Domain connecting to port $PORT via ngrok: $DOMAIN"
          else
            echo "No public ngrok HTTP/HTTPS tunnels found. Dumping ngrok log for debugging:"
            tail -n +1 ngrok.log || true
          fi

          echo "Server PID: $SERVER_PID"
          echo "ngrok PID: $NGROK_PID"

          # Wait for the server (the timeout will stop it after the requested duration)
          wait $SERVER_PID || true

          echo "Shutting down ngrok..."
          kill $NGROK_PID || true
          sleep 1
